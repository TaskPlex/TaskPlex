name: CI (Tests + Quality)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# Set minimal permissions for security
permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  lint-backend:
    name: Backend Linting
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install Linters
        run: |
          pip install ruff black isort

      - name: Run Ruff (Linter)
        run: |
          cd backend
          ruff check app/ tests/ --output-format=github

      - name: Run Ruff (Import Sorting Check)
        run: |
          cd backend
          ruff check app/ tests/ --select I --output-format=github

      - name: Run Ruff (Formatter Check)
        run: |
          cd backend
          ruff format app/ tests/ --check

  lint-frontend:
    name: Frontend Linting
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm ci

      - name: Run TypeScript Type Check
        run: |
          cd frontend
          npx tsc --noEmit

      - name: Lint Frontend
        run: |
          cd frontend
          npm run lint

      - name: Build Frontend (Check)
        run: |
          cd frontend
          npm run build

  test-backend:
    name: Backend Tests
    runs-on: ubuntu-22.04
    needs: [lint-backend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install Backend Dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx reportlab pytest-cov pytest-xdist

      - name: Run Backend Tests with Coverage
        run: |
          cd backend
          pytest tests/ \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term \
            --junitxml=junit.xml \
            -n auto  # Parallel execution
        env:
          COVERAGE_FILE: .coverage

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: Upload Test Results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: backend-test-results
          path: |
            backend/junit.xml
            backend/htmlcov/
          retention-days: 7

      - name: Check Coverage Threshold
        run: |
          cd backend
          coverage report --fail-under=70 || echo "‚ö†Ô∏è Coverage below 70%"

  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-22.04
    needs: [lint-frontend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm ci  # ci is faster and more reliable than install

      - name: Run Frontend Tests with Coverage
        run: |
          cd frontend
          npm run test -- --run --coverage --reporter=junit --outputFile=junit.xml
        env:
          CI: true

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

      - name: Upload Test Results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: frontend-test-results
          path: |
            frontend/junit.xml
            frontend/coverage/
          retention-days: 7

      - name: Analyze Bundle Size
        run: |
          cd frontend
          npm run build
          echo "üì¶ Bundle sizes:"
          du -sh dist/assets/*.js | sort -h
        continue-on-error: true

  test-frontend-tauri:
    name: Frontend Tests (Tauri ${{ matrix.platform }})
    runs-on: ubuntu-22.04
    needs: [lint-frontend]
    strategy:
      fail-fast: false
      matrix:
        platform: [linux, windows]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm ci

      - name: Run Tauri Tests (${{ matrix.platform }})
        run: |
          cd frontend
          npm run test:tauri:${{ matrix.platform }} -- --reporter=junit --outputFile=junit-tauri-${{ matrix.platform }}.xml
        env:
          CI: true
          TEST_ENV: tauri
          TEST_PLATFORM: ${{ matrix.platform }}

      - name: Upload Test Results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: frontend-tauri-${{ matrix.platform }}-test-results
          path: frontend/junit-tauri-${{ matrix.platform }}.xml
          retention-days: 7

